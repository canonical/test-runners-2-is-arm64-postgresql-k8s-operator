[33mWARNING [0m juju.client.connection:connection.py:654 RPC: Connection closed, reconnecting
[1m[31mERROR   [0m juju.client.connection:connection.py:662 RPC: Automatic reconnect failed
[32mINFO    [0m pytest_operator.plugin:plugin.py:862 Model status:

Model  Controller          Cloud/Region        Version  SLA          Timestamp
test   microk8s-localhost  microk8s/localhost  3.1.8    unsupported  02:18:06Z

App             Version  Status   Scale  Charm           Channel  Rev  Address        Exposed  Message
postgresql-k8s  14.11    waiting    3/0  postgresql-k8s             0  10.152.183.87  no       installing agent

Unit               Workload  Agent      Address    Ports  Message
postgresql-k8s/0   waiting   executing  10.1.3.18         awaiting for member to start
postgresql-k8s/1*  error     idle       10.1.3.20         hook failed: "database-peers-relation-changed"
postgresql-k8s/2   error     idle       10.1.3.19         hook failed: "database-peers-relation-changed"

[32mINFO    [0m pytest_operator.plugin:plugin.py:868 Juju error logs:

unit-postgresql-k8s-2: 01:39:48 ERROR juju.worker.uniter pebble poll failed for container "postgresql": failed to send pebble-ready event: terminated
unit-postgresql-k8s-1: 01:41:05 ERROR unit.postgresql-k8s/1.juju-log restart:2: failed to restart PostgreSQL
Traceback (most recent call last):
  File "/var/lib/juju/agents/unit-postgresql-k8s-1/charm/venv/urllib3/connection.py", line 196, in _new_conn
    sock = connection.create_connection(
  File "/var/lib/juju/agents/unit-postgresql-k8s-1/charm/venv/urllib3/util/connection.py", line 85, in create_connection
    raise err
  File "/var/lib/juju/agents/unit-postgresql-k8s-1/charm/venv/urllib3/util/connection.py", line 73, in create_connection
    sock.connect(sa)
ConnectionRefusedError: [Errno 111] Connection refused

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "/var/lib/juju/agents/unit-postgresql-k8s-1/charm/venv/urllib3/connectionpool.py", line 789, in urlopen
    response = self._make_request(
  File "/var/lib/juju/agents/unit-postgresql-k8s-1/charm/venv/urllib3/connectionpool.py", line 495, in _make_request
    conn.request(
  File "/var/lib/juju/agents/unit-postgresql-k8s-1/charm/venv/urllib3/connection.py", line 398, in request
    self.endheaders()
  File "/usr/lib/python3.10/http/client.py", line 1278, in endheaders
    self._send_output(message_body, encode_chunked=encode_chunked)
  File "/usr/lib/python3.10/http/client.py", line 1038, in _send_output
    self.send(msg)
  File "/usr/lib/python3.10/http/client.py", line 976, in send
    self.connect()
  File "/var/lib/juju/agents/unit-postgresql-k8s-1/charm/venv/urllib3/connection.py", line 236, in connect
    self.sock = self._new_conn()
  File "/var/lib/juju/agents/unit-postgresql-k8s-1/charm/venv/urllib3/connection.py", line 211, in _new_conn
    raise NewConnectionError(
urllib3.exceptions.NewConnectionError: <urllib3.connection.HTTPConnection object at 0xffffa067e290>: Failed to establish a new connection: [Errno 111] Connection refused

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "/var/lib/juju/agents/unit-postgresql-k8s-1/charm/venv/requests/adapters.py", line 667, in send
    resp = conn.urlopen(
  File "/var/lib/juju/agents/unit-postgresql-k8s-1/charm/venv/urllib3/connectionpool.py", line 843, in urlopen
    retries = retries.increment(
  File "/var/lib/juju/agents/unit-postgresql-k8s-1/charm/venv/urllib3/util/retry.py", line 519, in increment
    raise MaxRetryError(_pool, url, reason) from reason  # type: ignore[arg-type]
urllib3.exceptions.MaxRetryError: HTTPConnectionPool(host='postgresql-k8s-1.postgresql-k8s-endpoints', port=8008): Max retries exceeded with url: /restart (Caused by NewConnectionError('<urllib3.connection.HTTPConnection object at 0xffffa067e290>: Failed to establish a new connection: [Errno 111] Connection refused'))

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/var/lib/juju/agents/unit-postgresql-k8s-1/charm/venv/tenacity/__init__.py", line 472, in __call__
    result = fn(*args, **kwargs)
  File "/var/lib/juju/agents/unit-postgresql-k8s-1/charm/src/patroni.py", line 461, in restart_postgresql
    requests.post(f"{self._patroni_url}/restart", verify=self._verify)
  File "/var/lib/juju/agents/unit-postgresql-k8s-1/charm/venv/requests/api.py", line 115, in post
    return request("post", url, data=data, json=json, **kwargs)
  File "/var/lib/juju/agents/unit-postgresql-k8s-1/charm/venv/requests/api.py", line 59, in request
    return session.request(method=method, url=url, **kwargs)
  File "/var/lib/juju/agents/unit-postgresql-k8s-1/charm/venv/requests/sessions.py", line 589, in request
    resp = self.send(prep, **send_kwargs)
  File "/var/lib/juju/agents/unit-postgresql-k8s-1/charm/venv/requests/sessions.py", line 703, in send
    r = adapter.send(request, **kwargs)
  File "/var/lib/juju/agents/unit-postgresql-k8s-1/charm/venv/requests/adapters.py", line 700, in send
    raise ConnectionError(e, request=request)
requests.exceptions.ConnectionError: HTTPConnectionPool(host='postgresql-k8s-1.postgresql-k8s-endpoints', port=8008): Max retries exceeded with url: /restart (Caused by NewConnectionError('<urllib3.connection.HTTPConnection object at 0xffffa067e290>: Failed to establish a new connection: [Errno 111] Connection refused'))

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "/var/lib/juju/agents/unit-postgresql-k8s-1/charm/./src/charm.py", line 1545, in _restart
    self._patroni.restart_postgresql()
  File "/var/lib/juju/agents/unit-postgresql-k8s-1/charm/lib/charms/tempo_k8s/v1/charm_tracing.py", line 544, in wrapped_function
    return callable(*args, **kwargs)  # type: ignore
  File "/var/lib/juju/agents/unit-postgresql-k8s-1/charm/venv/tenacity/__init__.py", line 332, in wrapped_f
    return self(f, *args, **kw)
  File "/var/lib/juju/agents/unit-postgresql-k8s-1/charm/venv/tenacity/__init__.py", line 469, in __call__
    do = self.iter(retry_state=retry_state)
  File "/var/lib/juju/agents/unit-postgresql-k8s-1/charm/venv/tenacity/__init__.py", line 370, in iter
    result = action(retry_state)
  File "/var/lib/juju/agents/unit-postgresql-k8s-1/charm/venv/tenacity/__init__.py", line 413, in exc_check
    raise retry_exc from fut.exception()
tenacity.RetryError: RetryError[<Future at 0xffffa067e530 state=finished raised ConnectionError>]
unit-postgresql-k8s-2: 01:42:26 ERROR unit.postgresql-k8s/2.juju-log restart:2: failed to change plugins: 
Traceback (most recent call last):
  File "/var/lib/juju/agents/unit-postgresql-k8s-2/charm/lib/charms/postgresql_k8s/v0/postgresql.py", line 303, in enable_disable_extensions
    with self._connect_to_database() as connection, connection.cursor() as cursor:
  File "/var/lib/juju/agents/unit-postgresql-k8s-2/charm/lib/charms/tempo_k8s/v1/charm_tracing.py", line 544, in wrapped_function
    return callable(*args, **kwargs)  # type: ignore
  File "/var/lib/juju/agents/unit-postgresql-k8s-2/charm/lib/charms/postgresql_k8s/v0/postgresql.py", line 127, in _connect_to_database
    connection = psycopg2.connect(
  File "/var/lib/juju/agents/unit-postgresql-k8s-2/charm/venv/psycopg2/__init__.py", line 122, in connect
    conn = _connect(dsn, connection_factory=connection_factory, **kwasync)
psycopg2.OperationalError: connection to server at "postgresql-k8s-primary.test.svc.cluster.local" (10.152.183.165), port 5432 failed: Connection refused
	Is the server running on that host and accepting TCP/IP connections?


During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/var/lib/juju/agents/unit-postgresql-k8s-2/charm/./src/charm.py", line 639, in enable_disable_extensions
    self.postgresql.enable_disable_extensions(extensions, database)
  File "/var/lib/juju/agents/unit-postgresql-k8s-2/charm/lib/charms/tempo_k8s/v1/charm_tracing.py", line 544, in wrapped_function
    return callable(*args, **kwargs)  # type: ignore
  File "/var/lib/juju/agents/unit-postgresql-k8s-2/charm/lib/charms/postgresql_k8s/v0/postgresql.py", line 327, in enable_disable_extensions
    raise PostgreSQLEnableDisableExtensionError()
charms.postgresql_k8s.v0.postgresql.PostgreSQLEnableDisableExtensionError
unit-postgresql-k8s-0: 01:42:30 ERROR unit.postgresql-k8s/0.juju-log restart:2: failed to change plugins: 
Traceback (most recent call last):
  File "/var/lib/juju/agents/unit-postgresql-k8s-0/charm/lib/charms/postgresql_k8s/v0/postgresql.py", line 303, in enable_disable_extensions
    with self._connect_to_database() as connection, connection.cursor() as cursor:
  File "/var/lib/juju/agents/unit-postgresql-k8s-0/charm/lib/charms/tempo_k8s/v1/charm_tracing.py", line 544, in wrapped_function
    return callable(*args, **kwargs)  # type: ignore
  File "/var/lib/juju/agents/unit-postgresql-k8s-0/charm/lib/charms/postgresql_k8s/v0/postgresql.py", line 127, in _connect_to_database
    connection = psycopg2.connect(
  File "/var/lib/juju/agents/unit-postgresql-k8s-0/charm/venv/psycopg2/__init__.py", line 122, in connect
    conn = _connect(dsn, connection_factory=connection_factory, **kwasync)
psycopg2.OperationalError: connection to server at "postgresql-k8s-primary.test.svc.cluster.local" (10.152.183.165), port 5432 failed: Connection refused
	Is the server running on that host and accepting TCP/IP connections?


During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/var/lib/juju/agents/unit-postgresql-k8s-0/charm/./src/charm.py", line 639, in enable_disable_extensions
    self.postgresql.enable_disable_extensions(extensions, database)
  File "/var/lib/juju/agents/unit-postgresql-k8s-0/charm/lib/charms/tempo_k8s/v1/charm_tracing.py", line 544, in wrapped_function
    return callable(*args, **kwargs)  # type: ignore
  File "/var/lib/juju/agents/unit-postgresql-k8s-0/charm/lib/charms/postgresql_k8s/v0/postgresql.py", line 327, in enable_disable_extensions
    raise PostgreSQLEnableDisableExtensionError()
charms.postgresql_k8s.v0.postgresql.PostgreSQLEnableDisableExtensionError
unit-postgresql-k8s-1: 01:44:07 ERROR unit.postgresql-k8s/1.juju-log Cluster upgrade failed, ensure pre-upgrade checks are ran first.
unit-postgresql-k8s-2: 02:04:17 ERROR unit.postgresql-k8s/2.juju-log failed to change plugins: 
Traceback (most recent call last):
  File "/var/lib/juju/agents/unit-postgresql-k8s-2/charm/lib/charms/postgresql_k8s/v0/postgresql.py", line 303, in enable_disable_extensions
    with self._connect_to_database() as connection, connection.cursor() as cursor:
  File "/var/lib/juju/agents/unit-postgresql-k8s-2/charm/lib/charms/tempo_k8s/v1/charm_tracing.py", line 544, in wrapped_function
    return callable(*args, **kwargs)  # type: ignore
  File "/var/lib/juju/agents/unit-postgresql-k8s-2/charm/lib/charms/postgresql_k8s/v0/postgresql.py", line 127, in _connect_to_database
    connection = psycopg2.connect(
  File "/var/lib/juju/agents/unit-postgresql-k8s-2/charm/venv/psycopg2/__init__.py", line 122, in connect
    conn = _connect(dsn, connection_factory=connection_factory, **kwasync)
psycopg2.OperationalError: connection to server at "postgresql-k8s-primary.test.svc.cluster.local" (10.152.183.165), port 5432 failed: Connection refused
	Is the server running on that host and accepting TCP/IP connections?


During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/var/lib/juju/agents/unit-postgresql-k8s-2/charm/./src/charm.py", line 639, in enable_disable_extensions
    self.postgresql.enable_disable_extensions(extensions, database)
  File "/var/lib/juju/agents/unit-postgresql-k8s-2/charm/lib/charms/tempo_k8s/v1/charm_tracing.py", line 544, in wrapped_function
    return callable(*args, **kwargs)  # type: ignore
  File "/var/lib/juju/agents/unit-postgresql-k8s-2/charm/lib/charms/postgresql_k8s/v0/postgresql.py", line 327, in enable_disable_extensions
    raise PostgreSQLEnableDisableExtensionError()
charms.postgresql_k8s.v0.postgresql.PostgreSQLEnableDisableExtensionError
unit-postgresql-k8s-3: 02:04:37 ERROR unit.postgresql-k8s/3.juju-log failed to change plugins: 
Traceback (most recent call last):
  File "/var/lib/juju/agents/unit-postgresql-k8s-3/charm/lib/charms/postgresql_k8s/v0/postgresql.py", line 303, in enable_disable_extensions
    with self._connect_to_database() as connection, connection.cursor() as cursor:
  File "/var/lib/juju/agents/unit-postgresql-k8s-3/charm/lib/charms/tempo_k8s/v1/charm_tracing.py", line 544, in wrapped_function
    return callable(*args, **kwargs)  # type: ignore
  File "/var/lib/juju/agents/unit-postgresql-k8s-3/charm/lib/charms/postgresql_k8s/v0/postgresql.py", line 127, in _connect_to_database
    connection = psycopg2.connect(
  File "/var/lib/juju/agents/unit-postgresql-k8s-3/charm/venv/psycopg2/__init__.py", line 122, in connect
    conn = _connect(dsn, connection_factory=connection_factory, **kwasync)
psycopg2.OperationalError: connection to server at "postgresql-k8s-primary.test.svc.cluster.local" (10.152.183.165), port 5432 failed: Connection refused
	Is the server running on that host and accepting TCP/IP connections?


During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/var/lib/juju/agents/unit-postgresql-k8s-3/charm/./src/charm.py", line 639, in enable_disable_extensions
    self.postgresql.enable_disable_extensions(extensions, database)
  File "/var/lib/juju/agents/unit-postgresql-k8s-3/charm/lib/charms/tempo_k8s/v1/charm_tracing.py", line 544, in wrapped_function
    return callable(*args, **kwargs)  # type: ignore
  File "/var/lib/juju/agents/unit-postgresql-k8s-3/charm/lib/charms/postgresql_k8s/v0/postgresql.py", line 327, in enable_disable_extensions
    raise PostgreSQLEnableDisableExtensionError()
charms.postgresql_k8s.v0.postgresql.PostgreSQLEnableDisableExtensionError
controller-0: 02:06:35 ERROR juju.worker.caasapplicationprovisioner.runner exited "postgresql-k8s": updating filesystem information for postgresql-k8s: cannot set info for filesystem attachment 3:postgresql-k8s/3: state changing too quickly; try again soon
controller-0: 02:08:49 ERROR juju.worker.caasapplicationprovisioner.runner exited "postgresql-k8s": finding filesystem info for postgresql-k8s-pgdata-f9bd1295: unable to get persistent volume claim: k8s: persistentvolumeclaims "postgresql-k8s-pgdata-f9bd1295-postgresql-k8s-3" not found
unit-postgresql-k8s-2: 02:12:55 ERROR juju.worker.dependency "api-caller" manifold worker returned unexpected error: codec.ReadHeader error: error receiving message: read tcp 10.1.3.19:55588->10.152.183.26:17070: read: connection reset by peer
unit-postgresql-k8s-2: 02:12:55 ERROR juju.worker.uniter resolver loop error: committing operation "run relation-changed (0; app: postgresql-k8s) hook" for postgresql-k8s/2: committing hook "upgrade-relation-changed": could not persist relation 0 state: codec.ReadHeader error: error receiving message: read tcp 10.1.3.19:55588->10.152.183.26:17070: read: connection reset by peer
unit-postgresql-k8s-2: 02:12:55 ERROR juju.worker.caasunitterminationworker error while terminating unit: codec.ReadHeader error: error receiving message: read tcp 10.1.3.19:55588->10.152.183.26:17070: read: connection reset by peer
unit-postgresql-k8s-2: 02:12:55 ERROR juju.worker.uniter updating agent status: connection is shut down
unit-postgresql-k8s-0: 02:12:55 ERROR juju.worker.dependency "api-caller" manifold worker returned unexpected error: api connection broken unexpectedly
unit-postgresql-k8s-1: 02:12:55 ERROR juju.worker.dependency "api-caller" manifold worker returned unexpected error: codec.ReadHeader error: error receiving message: read tcp 10.1.3.20:36424->10.152.183.26:17070: read: connection reset by peer
unit-postgresql-k8s-1: 02:12:55 ERROR juju.worker.caasunitterminationworker error while terminating unit: codec.ReadHeader error: error receiving message: read tcp 10.1.3.20:36424->10.152.183.26:17070: read: connection reset by peer
unit-postgresql-k8s-1: 02:12:55 ERROR juju.worker.uniter resolver loop error: connection is shut down
unit-postgresql-k8s-1: 02:12:55 ERROR juju.worker.uniter updating agent status: connection is shut down
model-48480add-54ff-4b90-8e47-cdb02056e751: 02:12:55 ERROR juju.worker.dependency "api-caller" manifold worker returned unexpected error: api connection broken unexpectedly
unit-postgresql-k8s-0: 02:12:57 ERROR unit.postgresql-k8s/0.juju-log upgrade:0: Uncaught exception while in charm code:
Traceback (most recent call last):
  File "/var/lib/juju/agents/unit-postgresql-k8s-0/charm/./src/charm.py", line 1837, in <module>
    main(PostgresqlOperatorCharm, use_juju_for_storage=True)
  File "/var/lib/juju/agents/unit-postgresql-k8s-0/charm/venv/ops/main.py", line 546, in main
    manager = _Manager(charm_class, use_juju_for_storage=use_juju_for_storage)
  File "/var/lib/juju/agents/unit-postgresql-k8s-0/charm/venv/ops/main.py", line 428, in __init__
    self.framework = self._make_framework(self.dispatcher)
  File "/var/lib/juju/agents/unit-postgresql-k8s-0/charm/venv/ops/main.py", line 497, in _make_framework
    framework = ops.framework.Framework(
  File "/var/lib/juju/agents/unit-postgresql-k8s-0/charm/venv/ops/framework.py", line 646, in __init__
    self._stored = typing.cast(StoredStateData, self.load_snapshot(stored_handle))
  File "/var/lib/juju/agents/unit-postgresql-k8s-0/charm/venv/ops/framework.py", line 755, in load_snapshot
    data = self._storage.load_snapshot(handle.path)
  File "/var/lib/juju/agents/unit-postgresql-k8s-0/charm/venv/ops/storage.py", line 263, in load_snapshot
    content = self._backend.get(handle_path)
  File "/var/lib/juju/agents/unit-postgresql-k8s-0/charm/venv/ops/storage.py", line 402, in get
    p = _run(['state-get', key], stdout=subprocess.PIPE, check=True)
  File "/var/lib/juju/agents/unit-postgresql-k8s-0/charm/venv/ops/storage.py", line 48, in _run
    return subprocess.run([cmd, *args[1:]], encoding='utf-8', **kw)
  File "/usr/lib/python3.10/subprocess.py", line 526, in run
    raise CalledProcessError(retcode, process.args,
subprocess.CalledProcessError: Command '['/var/lib/juju/tools/unit-postgresql-k8s-0/state-get', 'StoredStateData[_stored]']' returned non-zero exit status 1.
unit-postgresql-k8s-0: 02:12:57 ERROR juju.worker.uniter.operation hook "upgrade-relation-changed" (via hook dispatching script: dispatch) failed: exit status 1
unit-postgresql-k8s-2: 02:12:58 ERROR juju.worker.dependency "api-caller" manifold worker returned unexpected error: [48480a] "unit-postgresql-k8s-2" cannot open api: unable to connect to API: dial tcp 10.152.183.26:17070: connect: connection refused
unit-postgresql-k8s-0: 02:12:58 ERROR juju.worker.dependency "api-caller" manifold worker returned unexpected error: [48480a] "unit-postgresql-k8s-0" cannot open api: unable to connect to API: dial tcp 10.152.183.26:17070: connect: connection refused
model-48480add-54ff-4b90-8e47-cdb02056e751: 02:12:59 ERROR juju.worker.dependency "api-caller" manifold worker returned unexpected error: [48480a] "model-48480add-54ff-4b90-8e47-cdb02056e751" cannot open api: unable to connect to API: dial tcp 10.152.183.26:17070: connect: connection refused
unit-postgresql-k8s-1: 02:12:59 ERROR juju.worker.dependency "api-caller" manifold worker returned unexpected error: [48480a] "unit-postgresql-k8s-1" cannot open api: unable to connect to API: dial tcp 10.152.183.26:17070: connect: connection refused

[32mINFO    [0m pytest_operator.plugin:plugin.py:947 Forgetting model main...